<html>
  <head>
    <link href="style.css" type="text/css" rel="stylesheet" />
  </head>
  <body>
    <div class="main">
      <div class="leftItem">
        <input type="file" id="file" onchange="uploadImage(this.files)" />
        <label for="file">upload</label>
        <button id="calculate" disabled>calculate</button>
        <input id="delta" class="hidden" type="text" />
        <button id="clear" disabled>clear</button>
        <div class="colorData">
          <label>координаты:</label>
          <span id="coord"></span>

          <label> цвет rgba:</label>
          <span id="rgba"></span>

          <div class="output2"></div>
        </div>
      </div>

      <div class="centeritem">
        <img src="" />
        <canvas id="canv"></canvas>
      </div>
    </div>
    <div class="hidden selectedColors">
      <!-- <div class="flex"><input type="range" min="0" max="255" value="50" id="r" /><label for="r">r</label></div> -->
      <!-- <div class="flex"><input type="range" min="0" max="255" value="50" id="g" /><label for="g">g</label></div> -->
      <!-- <div class="flex"><input type="range" min="0" max="255" value="50" id="b" /><label for="b">b</label></div>   -->
    </div>
  </body>
  <script>
    let arrayData = [];
    let data;
    addSquereWPickedColor.cur = 0;

    function uploadImage(a) {
      let img = document.querySelector("img");
      img.src = URL.createObjectURL(a[0]);
      img.onload = () => calculate(true);
    }

    function calculate(isFirstRender) {
      let canv = document.getElementById("canv");
      let img = document.querySelector("img");
      canv.width = img.width;
      canv.height = img.height;
      let qqq = canv.getContext("2d");
      qqq.drawImage(img, 0, 0, img.width, img.height);

      img.style.visibility = "hidden";

      if (isFirstRender) {
        data = qqq.getImageData(0, 0, canv.width, canv.height);
        getArrayOfColors(data.data);

        canv.addEventListener("mousemove", (e) => {
          showColor(e.offsetX, e.offsetY);
        });
        canv.addEventListener("click", (e) => {
          showColor(e.offsetX, e.offsetY, true);
        });
        document.getElementById("calculate").addEventListener("click", () => {
          redrawPixels(setDelta.color);
        });
      }
    }

    function showColor(x, y, isClicked) {
      document.getElementById("coord").innerHTML = `${x}  ${y}`;
      document.getElementById("rgba").innerHTML = arrayData[y * data.width + x];
      document.querySelector('[class="output2"]').style.backgroundColor = `rgb(${arrayData[y * data.width + x]})`;

      if (isClicked) {
        addSquereWPickedColor(x, y, true);
      }
    }

    function getArrayOfColors(array4) {
      for (let i = 8; i < array4.length - 4; i++) {
        if (i % 4 === 0) {
          arrayData.push(`${array4[i - 4]},${array4[i - 3]},${array4[i - 2]}`);
        }
      }
    }

    function addSquereWPickedColor(x, y, newPick) {
      let currcol;
      // console.log(addSquereWPickedColor.cur);
      if (addSquereWPickedColor.cur > 2) return;
      if (typeof arguments[0] == "string") {
        currcol = x;
      } else {
        currcol = arrayData[y * data.width + x];
      }
      document
        .querySelector('[class*="selectedColors"]')
        .insertAdjacentHTML("beforeend", `<div class="output" style="background-color: rgb(${currcol})">`);

      document.querySelector('[class*="selectedColors"]').classList.remove("hidden");
      document.getElementById("clear").addEventListener("click", () => clearSelectedColors());
      disableButtonById("clear", false);

      if (newPick) {
        let list = document.querySelectorAll('[class="output"]');
        // list[list.length - 1].addEventListener("click", () => {
        //   addRangeSq(currcol);
        // });
        return setDelta(currcol);
      }
      addSquereWPickedColor.cur++;
    }

    // function addRangeSq(color) {
    //   lowerColor = "";
    //   upperColor = "";

    //   for (let i of color.split(",")) {
    //     +i - 20 > 0 ? (lowerColor += `${+i - 20},`) : (lowerColor += "0,");
    //     +i + 20 < 255 ? (upperColor += `${+i + 20},`) : (upperColor += "255,");
    //   }

    //   addSquereWPickedColor(lowerColor.substring(0, lowerColor.length - 1), null, false);
    //   addSquereWPickedColor(upperColor.substring(0, upperColor.length - 1), null, false);
    //   document.querySelector('[class*="selectedColors"]').classList.remove("hidden");

    //   return setDelta(color);
    // }

    function setDelta(clr) {
      document.querySelector("#delta").classList.remove("hidden");
      disableButtonById("calculate", false);
      let res = {
        color: clr,
        r: 0,
        g: 0,
        b: 0,
      };
      setDelta.color = clr;
    }

    function redrawPixels(color) {
      if (redrawPixels.redrawed) {
        redrawPixels.redrawed = false;
        calculate(false);
      }
      let percent = 0;
      let canvas = document.getElementById("canv");
      let ctx = canvas.getContext("2d");
      ctx.fillStyle = "#fd02bf";
      // let delta = document.querySelector("input#delta").value;
      // console.log(delta);
      let localInputColor = color.split(",");

      for (let i = 0; i < arrayData.length; i++) {
        let currColor = arrayData[i].split(",");
        if (
          ((+currColor[0] - +localInputColor[0]) ** 2 + (+currColor[1] - +localInputColor[1]) ** 2 + (+currColor[2] - +localInputColor[2]) ** 2) **
            0.5 <
          document.querySelector("input#delta").value
        ) {
          ctx.fillRect(i % data.width, i / data.width, 1, 1);
          percent++;
        }
      }
      console.log((percent / arrayData.length) * 100);
      // disableButtonById("calculate", true);

      redrawPixels.redrawed = true;
    }

    function clearSelectedColors() {
      console.log("adas");
      document.querySelector('[class*="selectedColors"]').innerHTML = ``;

      disableButtonById("clear", true);
      disableButtonById("calculate", true);
      addSquereWPickedColor.cur = 0;
      document.querySelector("#delta").classList.add("hidden");
      document.querySelector('[class*="selectedColors"]').classList.add("hidden");
      return redrawPixels.redrawed ? (calculate(false), (redrawPixels.redrawed = false)) : null;
    }

    function disableButtonById(name, state) {
      document.getElementById(`${name}`).disabled = state;
    }
  </script>
</html>
